services:
  dhcp-monitor:
    build: .
    container_name: dhcp_watcher
    restart: always
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=America/Phoenix
      - OPNSENSE_URL=${OPNSENSE_URL}
      - OPN_API_KEY=${OPN_API_KEY}
      - OPN_API_SECRET=${OPN_API_SECRET}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
      - OLLAMA_HOST=10.13.20.8
      - POLL_INTERVAL=120
      - SPEEDTEST_API_URL=http://speedtest_monitor/api/speedtest/latest
      # Bandwidth thresholds
      - SPEED_DROP_THRESHOLD=0.5
      - WG_SESSION_ALERT_GB=5.0
      - DAILY_BANDWIDTH_ALERT_GB=100.0 # Alert if daily total >100GB
      # Anomaly detection thresholds
      - DHCP_BURST_THRESHOLD=5
      - DHCP_BURST_WINDOW=5
      - DISCONNECT_CYCLE_THRESHOLD=3
      - DISCONNECT_CYCLE_WINDOW=10
      - ARP_STABLE_THRESHOLD=3  # Default: 3 checks (6 minutes)
#    ports:
#      - "3019:3019"
    depends_on:
      - speedtest

  speedtest:
    image: henrywhitaker3/speedtest-tracker
    container_name: speedtest_monitor
    restart: unless-stopped
    ports:
      - "8765:80"
    environment:
      - TZ=America/Phoenix
      - OOKLA_EULA_GDPR=true
      - APP_URL=http://10.13.20.8:8765
      - DB_CONNECTION=sqlite
      - SPEEDTEST_SCHEDULE=0 */6 * * *
      - PRUNE_RESULTS_OLDER_THAN=60
    volumes:
      - ./speedtest_data:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/speedtest/latest"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

